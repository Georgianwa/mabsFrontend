<%- include('partials/header') %>

<main class="product-page">
    <div class="container">
        <div class="breadcrumb">
            <a href="/">Home</a> / 
            <a href="/categories">Categories</a> / 
            <% if (product.category) { %>
                <a href="/category/<%= product.category._id || product.category %>">
                    <%= product.category.title || 'Category' %>
                </a> / 
            <% } %>
            <span><%= product.name %></span>
        </div>
        
        <div class="product-detail">
            <div class="product-gallery">
                <div class="main-image">
                    <% 
                    let mainImageUrl = '';
                    if (product.images && Array.isArray(product.images) && product.images.length > 0) {
                        mainImageUrl = product.images[0];
                    } else if (product.images && typeof product.images === 'string') {
                        mainImageUrl = product.images;
                    }
                    %>
                    <img src="<%= mainImageUrl || '/images/placeholder.jpg' %>" alt="<%= product.name %>" id="main-product-image" onerror="this.src='/images/placeholder.jpg'">
                </div>
                <% if (product.images && Array.isArray(product.images) && product.images.length > 1) { %>
                    <div class="thumbnail-images">
                        <% product.images.forEach((image, index) => { %>
                            <img src="<%= image %>" 
                                 alt="<%= product.name %>" 
                                 class="<%= index === 0 ? 'active' : '' %>" 
                                 onclick="changeImage('<%= image %>')"
                                 onerror="this.style.display='none'">
                        <% }); %>
                    </div>
                <% } %>
            </div>
            
            <div class="product-details">
                <p class="product-brand"><%= product.brand?.name || product.brand %></p>
                <h1><%= product.name %></h1>
                
                <div class="product-price-section">
                    <p class="product-price">₦<%= product.price ? product.price.toLocaleString() : '0' %></p>
                </div>
                
                <div class="product-description">
                    <h3>Description</h3>
                    <p><%= product.description %></p>
                </div>
                
                <div class="product-actions">
                    <button class="btn btn-primary" onclick="handleAddToCart()">
                        <i class="fas fa-shopping-cart"></i> Add to Cart
                    </button>
                </div>
                
                <div class="product-meta">
                    <% if (product.category) { %>
                        <p><strong>Category:</strong> <%= product.category.title || product.category %></p>
                    <% } %>
                    <% if (product.brand) { %>
                        <p><strong>Brand:</strong> <%= product.brand.name || product.brand %></p>
                    <% } %>
                </div>
            </div>
        </div>
        
        <% if (product.productSpecifications && Object.keys(product.productSpecifications).length > 0) { %>
            <div class="product-specifications">
                <h2>Specifications</h2>
                <div class="specs-grid">
                    <% 
                    const specs = product.productSpecifications;
                    if (specs instanceof Map) {
                        for (const [key, value] of specs) { %>
                            <div class="spec-item">
                                <strong><%= key %>:</strong>
                                <span><%= value %></span>
                            </div>
                        <% }
                    } else {
                        for (const [key, value] of Object.entries(specs)) { %>
                            <div class="spec-item">
                                <strong><%= key %>:</strong>
                                <span><%= value %></span>
                            </div>
                        <% }
                    } %>
                </div>
            </div>
        <% } %>
        
        <% if (typeof relatedProducts !== 'undefined' && relatedProducts && relatedProducts.length > 0) { %>
            <section class="related-products">
                <h2>Related Products</h2>
                <div class="products-grid">
                    <% relatedProducts.forEach(relatedProduct => { %>
                        <div class="product-card">
                            <div class="product-image">
                                <a href="/product/<%= relatedProduct._id || relatedProduct.id %>">
                                    <% 
                                    let relatedImageUrl = '';
                                    if (relatedProduct.images && Array.isArray(relatedProduct.images) && relatedProduct.images.length > 0) {
                                        relatedImageUrl = relatedProduct.images[0];
                                    } else if (relatedProduct.images && typeof relatedProduct.images === 'string') {
                                        relatedImageUrl = relatedProduct.images;
                                    }
                                    %>
                                    <img src="<%= relatedImageUrl || '/images/placeholder.jpg' %>" alt="<%= relatedProduct.name %>" onerror="this.src='/images/placeholder.jpg'">
                                </a>
                            </div>
                            <div class="product-info">
                                <p class="product-brand"><%= relatedProduct.brand?.name || relatedProduct.brand %></p>
                                <h3 class="product-name">
                                    <a href="/product/<%= relatedProduct._id || relatedProduct.id %>"><%= relatedProduct.name %></a>
                                </h3>
                                <p class="product-price">₦<%= relatedProduct.price ? relatedProduct.price.toLocaleString() : '0' %></p>
                                <a href="/product/<%= relatedProduct._id || relatedProduct.id %>" class="btn btn-outline">View Details</a>
                            </div>
                        </div>
                    <% }); %>
                </div>
            </section>
        <% } %>
    </div>
</main>

<script>
// Product data
const productData = {
    id: '<%= product._id || product.id %>',
    name: '<%= product.name.replace(/'/g, "\\'") %>',
    price: <%= product.price || 0 %>,
    image: '<%= mainImageUrl || "/images/placeholder.jpg" %>'
};

function changeImage(imageSrc) {
    const mainImage = document.getElementById('main-product-image');
    mainImage.src = imageSrc;
    
    document.querySelectorAll('.thumbnail-images img').forEach(img => {
        img.classList.remove('active');
        if (img.src === imageSrc) {
            img.classList.add('active');
        }
    });
}

function handleAddToCart() {
    // Use the addToCart function from cart.js
    if (typeof addToCart === 'function') {
        addToCart(
            productData.id,
            productData.name,
            productData.price,
            productData.image
        );
    } else {
        console.error('Cart function not loaded');
        alert('Unable to add to cart. Please refresh the page.');
    }
}
</script>

<%- include('partials/footer') %>